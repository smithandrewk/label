<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accelerometer Data Visualization</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        body {
            display: flex;
            min-height: 100vh;
            margin: 0;
        }
        .sidebar {
            width: 250px;
            background-color: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #dee2e6;
        }
        .main-content {
            flex-grow: 1;
            padding: 20px;
        }
        #visualization-view {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <h4>Data Sessions</h4>
        <ul class="nav flex-column" id="session-list">
            <!-- Populated by JavaScript -->
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Table View -->
        <div id="table-view">
            <h2>Available Sessions</h2>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Session</th>
                        <th>File</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="sessions-table-body">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Visualization View -->
        <div id="visualization-view">
            <div class="visualization-container">
                <button class="btn btn-secondary mb-3" onclick="showTableView()">Back to Table</button>
                <h2>Accelerometer Data Visualization</h2>
                <!-- Session Details and Action Buttons -->
                <div id="session-details"></div>
                <div id="action-buttons" class="mb-3">
                    <!-- Dynamic buttons based on status -->
                </div>
            </div>
            <!-- Plot Container -->
            <div class="plot-container">
                <div id="timeSeriesPlot"></div>
            </div>
            <!-- Add to the visualization section -->
            <div id="boutEditor" style="margin-top: 20px;">
                <h3>Edit Bouts</h3>
                <table id="boutTable" border="1">
                    <thead>
                        <tr>
                            <th>Bout</th>
                            <th>Start Index</th>
                            <th>End Index</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="boutTableBody"></tbody>
                </table>
                <button onclick="addBout()">Add Bout</button>
                <button onclick="saveBouts()">Save Bouts</button>
                <script>

                </script>
            </div>
        </div>

        <style>
            #visualization-view {
                display: none;
                flex-direction: column;
                width: 100%;
                height: 100%; /* Full viewport height */
            }
            .visualization-container {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                width: 100%;
                height: 100px;
            }
            #action-buttons {
                display: flex;
                gap: 10px;
            }
            .plot-container {
                display: flex;
                height: 100%;
                width: 100%;
            }
            #timeSeriesPlot {
                flex-grow: 1;
                height: 100%;
            }

        </style>
        <!-- Label Modal -->
        <div class="modal fade" id="labelModal" tabindex="-1" aria-labelledby="labelModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="labelModalLabel">Label Session</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="labelInput" class="form-label">Enter Label (e.g., Walking, Running)</label>
                            <input type="text" class="form-control" id="labelInput">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveLabel()">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script>
        let sessions = [];
        let currentSessionName = null;
        let currentActiveSession = null; // Track the currently visualized session

        function updateBoutTable(session) {
        const tbody = document.getElementById('boutTableBody');
            tbody.innerHTML = '';
            session.segments.forEach((seg, i) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>Bout ${i+1}</td>
                    <td><input type="number" value="${seg.start}" onchange="updateSegment(${i}, 'start', this.value)"></td>
                    <td><input type="number" value="${seg.end}" onchange="updateSegment(${i}, 'end', this.value)"></td>
                    <td><button onclick="removeBout(${i})">Remove</button></td>
                `;
                tbody.appendChild(row);
            });
        }
        function addBout() {
            const session = sessions.find(s => s.name === currentActiveSession);
            console.log(session.segments)
            session.segments.push({ start: 0, end: 100 }); // Default values
            updateBoutTable(session);
        }
        // Fetch sessions from backend
        async function fetchSessions() {
            try {
                const response = await fetch('/api/sessions');
                if (!response.ok) throw new Error('Failed to fetch sessions');
                sessions = await response.json();
                for (let session of sessions) {
                    const metadata = await fetchSessionMetadata(session.name);
                    session.status = metadata.status;
                    session.keep = metadata.keep;
                    session.label = metadata.label;
                    session.segments = [];
                    // session.segments = JSON.parse(metadata.segments || '[]');
                    session.data = [];
                }
                populateSessions();
            } catch (error) {
                console.error('Error fetching sessions:', error);
            }
        }

        // Fetch session metadata
        async function fetchSessionMetadata(sessionName) {
            try {
                const response = await fetch(`/api/session/${sessionName}/metadata`);
                if (!response.ok) throw new Error('Failed to fetch metadata');
                return await response.json();
            } catch (error) {
                console.error('Error fetching metadata:', error);
                return { status: 'Initial', keep: null, label: '', segments: '[]' };
            }
        }

        // Update session metadata
        async function updateSessionMetadata(session) {
            try {
                const response = await fetch(`/api/session/${session.name}/metadata`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: session.status,
                        keep: session.keep,
                        label: session.label,
                        segments: session.segments
                    })
                });
                if (!response.ok) throw new Error('Failed to update metadata');
            } catch (error) {
                console.error('Error updating metadata:', error);
            }
        }

        // Load session data
        async function loadSessionData(sessionName) {
            try {
                const response = await fetch(`/api/session/${sessionName}`);
                if (!response.ok) throw new Error('Failed to fetch session data');
                return await response.json();
            } catch (error) {
                console.error('Error loading session data:', error);
                return [];
            }
        }

        // Populate sidebar and table
        function populateSessions() {
            const sessionList = document.getElementById("session-list");
            const tbody = document.getElementById("sessions-table-body");
            sessionList.innerHTML = "";
            tbody.innerHTML = "";
            sessions.forEach(session => {
                if (session.keep !== 0) {
                    //Sidebar
                    const li = document.createElement("li");
                    li.className = "nav-item";
                    const linkClass = session.name === currentActiveSession ? "nav-link active-session" : "nav-link";
                    li.innerHTML = `<a class="${linkClass}" href="#" onclick="visualizeSession('${session.name}')">${session.name}</a>`;
                    sessionList.appendChild(li);

                    // Table
                    const row = document.createElement("tr");
                    let actionButton = "";
                    if (session.status === "Initial") {
                        actionButton = `<button class="btn btn-primary btn-sm" onclick="visualizeSession('${session.name}')">Visualize</button>`;
                    } else if (session.status === "Visualized") {
                        actionButton = `<button class="btn btn-success btn-sm me-1" onclick="decideSession('${session.name}', true)">Keep</button>` +
                                    `<button class="btn btn-danger btn-sm" onclick="decideSession('${session.name}', false)">Discard</button>`;
                    } else if (session.status === "Decision Made" && session.keep) {
                        actionButton = `<button class="btn btn-primary btn-sm" onclick="openLabelModal('${session.name}')">Label</button>`;
                    } else if (session.status === "Labeled") {
                        actionButton = `<button class="btn btn-primary btn-sm" onclick="segmentSession('${session.name}')">Segment</button>`;
                    }
                    row.innerHTML = `
                        <td>${session.name}</td>
                        <td>${session.file}</td>
                        <td>${session.status}${session.label ? ': ' + session.label : ''}${session.keep === false ? ' (Discarded)' : ''}</td>
                        <td>${actionButton}</td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        // Show table view
        function showTableView() {
            document.getElementById("table-view").style.display = "flex";
            document.getElementById("visualization-view").style.display = "none";
        }

        // Show visualization view
        async function visualizeSession(sessionName) {
            const session = sessions.find(s => s.name === sessionName);
            if (!session) {
                console.error('Session not found:', sessionName);
                return;
            }

            if (!session.data || session.data.length === 0) {
                session.data = await loadSessionData(sessionName);
                if (!session.data || session.data.length === 0) {
                    console.error('No valid data for session:', sessionName);
                    return;
                }
            }

            const validData = session.data.every(d => 
                d.ns_since_reboot && 
                typeof d.x === 'number' && 
                typeof d.y === 'number' && 
                typeof d.z === 'number' &&
                typeof d.label === 'number'
            );
            if (!validData) {
                console.error('Invalid data format:', session.data);
                return;
            }

            document.getElementById("table-view").style.display = "none";
            document.getElementById("visualization-view").style.display = "flex";

            if (session.status === "Initial") {
                session.status = "Visualized";
                await updateSessionMetadata(session);
                populateSessions();
            }

            const detailsDiv = document.getElementById("session-details");
            detailsDiv.innerHTML = `
                <p><strong>Session:</strong> ${session.name}</p>
                <p><strong>File:</strong> ${session.file}</p>
                <p><strong>Status:</strong> ${session.status}</p>
                ${session.keep === false ? '<p><strong>Decision:</strong> Discarded</p>' : ''}
                ${session.label ? `<p><strong>Label:</strong> ${session.label}</p>` : ''}
                ${session.segments.length > 0 ? `<p><strong>Segments:</strong> ${session.segments.length}</p>` : ''}
            `;

            const actionButtons = document.getElementById("action-buttons");
            actionButtons.innerHTML = "";
            if (session.status === "Visualized") {
                actionButtons.innerHTML = `
                    <button class="btn btn-success btn-sm me-1" onclick="decideSession('${session.name}', true)">Keep</button>
                    <button class="btn btn-danger btn-sm" onclick="decideSession('${session.name}', false)">Discard</button>
                `;
            } else if (session.status === "Decision Made" && session.keep) {
                actionButtons.innerHTML = `<button class="btn btn-primary btn-sm" onclick="openLabelModal('${session.name}')">Label</button>`;
            } else if (session.status === "Labeled") {
                actionButtons.innerHTML = `<button class="btn btn-primary btn-sm" onclick="segmentSession('${session.name}')">Segment</button>`;
            }

            const dataToPlot = session.segments.length > 0 ? session.segments.flat() : session.data;
            if (!dataToPlot || dataToPlot.length === 0) {
                console.error('No data to plot for session:', sessionName);
                return;
            }
            const timestamps = dataToPlot.map(d => d.ns_since_reboot).filter(t => t);
            const xValues = dataToPlot.map(d => d.x).filter(x => typeof x === 'number');
            const yValues = dataToPlot.map(d => d.y).filter(y => typeof y === 'number');
            const zValues = dataToPlot.map(d => d.z).filter(z => typeof z === 'number');
            const labels = dataToPlot.map(d => d.label).filter(label => typeof label === 'number');
            if (timestamps.length === 0) {
                console.error('No valid timestamps for plotting');
                return;
            }

            const traces = [
                { x: timestamps, y: xValues, name: 'X Axis', type: 'scatter', mode: 'lines', line: { color: '#17BECF' } },
                { x: timestamps, y: yValues, name: 'Y Axis', type: 'scatter', mode: 'lines', line: { color: '#FF7F0E' } },
                { x: timestamps, y: zValues, name: 'Z Axis', type: 'scatter', mode: 'lines', line: { color: '#2CA02C' } },
                { x: timestamps, y: labels, name: 'Z Axis', type: 'scatter', mode: 'lines', line: { color: '#FF0000' } }
            ];
            if (session.segments.length > 0) {
                session.segments.forEach((segment, i) => {
                    traces.push({
                        x: [segment[0].ns_since_reboot, segment[segment.length - 1].ns_since_reboot],
                        y: [0, 0],
                        name: `Segment ${i + 1}`,
                        type: 'scatter',
                        mode: 'markers',
                        marker: { size: 5, symbol: 'circle', color: '#D62728' }
                    });
                });
            }

            const layout = {
                xaxis: { title: 'Timestamp', type: 'date', rangeslider: { visible: false } },
                yaxis: { title: 'Acceleration (m/sÂ²)'}, // Set y-axis limits
                showlegend: true
            };

            Plotly.newPlot('timeSeriesPlot', traces, layout);
        }

        // Decide to keep or discard
        async function decideSession(sessionName, keep) {
            const session = sessions.find(s => s.name === sessionName);
            if (!session) return;
            session.status = "Decision Made";
            session.keep = keep;
            await updateSessionMetadata(session);
            populateSessions();
            visualizeSession(sessionName);
        }

        // Open label modal
        function openLabelModal(sessionName) {
            currentSessionName = sessionName;
            const modal = new bootstrap.Modal(document.getElementById("labelModal"));
            document.getElementById("labelInput").value = "";
            modal.show();
        }

        // Save label
        async function saveLabel() {
            const session = sessions.find(s => s.name === currentSessionName);
            if (!session) return;
            const label = document.getElementById("labelInput").value.trim();
            if (label) {
                session.label = label;
                session.status = "Labeled";
                await updateSessionMetadata(session);
                populateSessions();
                visualizeSession(session.name);
            }
            bootstrap.Modal.getInstance(document.getElementById("labelModal")).hide();
        }

        // Segment session data
        async function segmentSession(sessionName) {
            const session = sessions.find(s => s.name === sessionName);
            if (!session) return;

            const segments = [];
            let currentSegment = [];
            for (let i = 0; i < session.data.length; i++) {
                currentSegment.push(session.data[i]);
                if (i < session.data.length - 1) {
                    const currentTime = new Date(session.data[i].ns_since_reboot);
                    const nextTime = new Date(session.data[i + 1].ns_since_reboot);
                    if (isNaN(currentTime) || isNaN(nextTime)) {
                        console.error('Invalid timestamp:', session.data[i].ns_since_reboot);
                        continue;
                    }
                    const gap = (nextTime - currentTime) / 1000;
                    if (gap > 1) {
                        segments.push(currentSegment);
                        currentSegment = [];
                    }
                }
            }
            if (currentSegment.length > 0) segments.push(currentSegment);

            session.segments = segments;
            session.status = "Segmented";
            await updateSessionMetadata(session);
            populateSessions();
            visualizeSession(sessionName);
        }

        // Initialize
        fetchSessions();
    </script>
</body>
</html>